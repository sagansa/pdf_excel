<template>
  <div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-2xl font-bold text-gray-900">Income Statement (Comparative)</h2>
      <p class="text-sm text-gray-500 mt-1">Laporan Laba Rugi Komparatif</p>
    </div>

    <!-- Empty State -->
    <div v-if="!data" class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
      <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="bi bi-file-earmark-bar-graph text-3xl"></i>
      </div>
      <h3 class="text-lg font-bold text-gray-900">No Report Generated</h3>
      <p class="text-gray-500 text-sm mt-1">Select a period and click "Generate Report" to view the income statement</p>
    </div>

    <!-- Revenue Section -->
    <div v-else class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-green-50 border-b border-green-100 px-6 py-3">
        <h3 class="text-sm font-bold text-green-900 uppercase">Revenue</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase w-[100px]">Code</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account Name</th>
              <th v-if="data?.comparative" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase w-[150px]">Previous Year</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase w-[150px]">Current Year</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase w-[80px]">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <tr v-if="!data?.revenue || data.revenue.length === 0">
              <td :colspan="data?.comparative ? 5 : 4" class="px-6 py-8 text-center text-gray-400 text-sm">No revenue recorded</td>
            </tr>
            <tr v-for="item in data?.revenue || []" :key="item.code" class="group">
              <td class="px-6 py-3 text-sm font-mono font-semibold text-gray-900">{{ item.code }}</td>
              <td class="px-6 py-3 text-sm text-gray-900">{{ item.name }}</td>
              <td v-if="data?.comparative" class="px-6 py-3 text-sm text-right font-semibold text-gray-600">
                <span class="whitespace-nowrap tabular-nums">{{ formatCurrency(item.previous_year_amount || 0) }}</span>
              </td>
              <td class="px-6 py-3 text-sm text-right font-semibold text-green-700">
                <span class="whitespace-nowrap tabular-nums">{{ formatCurrency(item.amount) }}</span>
              </td>
              <td class="px-6 py-3 text-center">
                <div class="flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button
                    @click.stop.prevent="copyToClipboard(item.amount)"
                    class="text-gray-400 hover:text-green-600 transition-colors p-1"
                    title="Copy amount"
                  >
                    <i class="bi bi-clipboard text-xs"></i>
                  </button>
                  <button
                    @click.stop.prevent="openCoaDetail(item)"
                    class="text-gray-400 hover:text-indigo-600 transition-colors p-1"
                    title="View transactions"
                  >
                    <i class="bi bi-list-ul text-xs"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
          <tfoot v-if="data?.revenue && data.revenue.length > 0" class="bg-green-50 font-bold">
            <tr>
              <td colspan="2" class="px-6 py-3 text-sm text-green-900">Total Revenue</td>
              <td v-if="data?.comparative" class="px-6 py-3 text-sm text-right text-green-900">
                {{ formatCurrency(data.previous_year_total_revenue || 0) }}
              </td>
              <td class="px-6 py-3 text-sm text-right text-green-900">
                {{ formatCurrency(data.total_revenue) }}
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Expenses Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-red-50 border-b border-red-100 px-6 py-3">
        <h3 class="text-sm font-bold text-red-900 uppercase">Expenses</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase w-[100px]">Code</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account Name</th>
              <th v-if="data?.comparative" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase w-[150px]">Previous Year</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase w-[150px]">Current Year</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase w-[80px]">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <tr v-if="!data?.expenses || data.expenses.length === 0">
              <td :colspan="data?.comparative ? 5 : 4" class="px-6 py-8 text-center text-gray-400 text-sm">No expenses recorded</td>
            </tr>
            <tr v-for="item in data?.expenses || []" :key="item.code" class="group">
              <td class="px-6 py-3 text-sm font-mono font-semibold text-gray-900">{{ item.code }}</td>
              <td class="px-6 py-3 text-sm text-gray-900">{{ item.name }}</td>
              <td v-if="data?.comparative" class="px-6 py-3 text-sm text-right font-semibold text-gray-600">
                <span class="whitespace-nowrap tabular-nums">{{ formatCurrency(item.previous_year_amount || 0) }}</span>
              </td>
              <td class="px-6 py-3 text-sm text-right font-semibold text-red-700">
                <span class="whitespace-nowrap tabular-nums">{{ formatCurrency(item.amount) }}</span>
              </td>
              <td class="px-6 py-3 text-center">
                <div class="flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button
                    @click.stop.prevent="copyToClipboard(item.amount)"
                    class="text-gray-400 hover:text-red-600 transition-colors p-1"
                    title="Copy amount"
                  >
                    <i class="bi bi-clipboard text-xs"></i>
                  </button>
                  <button
                    @click.stop.prevent="openCoaDetail(item)"
                    class="text-gray-400 hover:text-indigo-600 transition-colors p-1"
                    title="View transactions"
                  >
                    <i class="bi bi-list-ul text-xs"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
          <tfoot v-if="data?.expenses && data.expenses.length > 0" class="bg-red-50 font-bold">
            <tr>
              <td colspan="2" class="px-6 py-3 text-sm text-red-900">Total Expenses</td>
              <td v-if="data?.comparative" class="px-6 py-3 text-sm text-right text-red-900">
                {{ formatCurrency(data.previous_year_total_expenses || 0) }}
              </td>
              <td class="px-6 py-3 text-sm text-right text-red-900">
                {{ formatCurrency(data.total_expenses) }}
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- COGS Section -->
    <div v-if="data?.cogs_breakdown && data.cogs_breakdown.total_cogs > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-blue-50 border-b border-blue-100 px-6 py-3">
        <h3 class="text-sm font-bold text-blue-900 uppercase">Cost of Goods Sold</h3>
      </div>
      <div class="p-6 space-y-6">
        <!-- Inventory Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-xs font-medium text-blue-600 uppercase mb-1">Beginning Inventory - 5008</p>
            <p class="text-lg font-bold text-blue-900 whitespace-nowrap tabular-nums">{{ formatCurrency(data.cogs_breakdown.beginning_inventory) }}</p>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-xs font-medium text-blue-600 uppercase mb-1">- Ending Inventory - 5009</p>
            <p class="text-lg font-bold text-blue-900 whitespace-nowrap tabular-nums">{{ formatCurrency(data.cogs_breakdown.ending_inventory) }}</p>
          </div>
          <div class="bg-blue-100 border border-blue-200 rounded-lg p-4">
            <p class="text-xs font-medium text-blue-600 uppercase mb-1">Total COGS</p>
            <p class="text-lg font-bold text-blue-900 whitespace-nowrap tabular-nums">{{ formatCurrency(data.cogs_breakdown.total_cogs) }}</p>
          </div>
        </div>

        <!-- Purchases Breakdown Table (Comparative) -->
        <div v-if="data.cogs_breakdown.purchases_items && data.cogs_breakdown.purchases_items.length > 0">
          <div class="bg-blue-100 border-b border-blue-200 px-6 py-2 mb-3">
            <h4 class="text-xs font-bold text-blue-800 uppercase">Purchases Breakdown</h4>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase w-[100px]">Code</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account Name</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase w-[150px]">Previous Year</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase w-[150px]">Current Year</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase w-[80px]">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <tr v-for="item in data.cogs_breakdown.purchases_items" :key="item.code" class="group">
                  <td class="px-6 py-3 text-sm font-mono font-semibold text-gray-900">{{ item.code }}</td>
                  <td class="px-6 py-3 text-sm text-gray-900">{{ item.name }}</td>
                  <td class="px-6 py-3 text-sm text-right font-semibold text-gray-600">
                    <span class="whitespace-nowrap tabular-nums">{{ formatCurrency(item.previous_year_amount || 0) }}</span>
                  </td>
                  <td class="px-6 py-3 text-sm text-right font-semibold text-blue-700">
                    <span class="whitespace-nowrap tabular-nums">{{ formatCurrency(item.amount) }}</span>
                  </td>
                  <td class="px-6 py-3 text-center">
                    <div class="flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button @click.stop.prevent="copyToClipboard(item.amount)" class="text-gray-400 hover:text-blue-600 transition-colors p-1" title="Copy amount">
                        <i class="bi bi-clipboard text-xs"></i>
                      </button>
                      <button @click.stop.prevent="openCoaDetail(item)" class="text-gray-400 hover:text-indigo-600 transition-colors p-1" title="View transactions">
                        <i class="bi bi-list-ul text-xs"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
              <tfoot class="bg-blue-50 font-bold">
                <tr>
                  <td colspan="2" class="px-6 py-3 text-sm text-blue-900">Total Purchases</td>
                  <td class="px-6 py-3 text-sm text-right text-blue-900">
                    {{ formatCurrency(data.cogs_breakdown.previous_year_purchases || 0) }}
                  </td>
                  <td class="px-6 py-3 text-sm text-right text-blue-900">
                    <div class="flex items-center justify-end gap-2">
                      <span class="whitespace-nowrap tabular-nums">{{ formatCurrency(data.cogs_breakdown.purchases) }}</span>
                      <!-- <button @click.stop.prevent="copyToClipboard(data.cogs_breakdown.purchases)" class="text-gray-400 hover:text-blue-600 transition-colors p-1" title="Copy amount">
                        <i class="bi bi-clipboard text-xs"></i>
                      </button> -->
                    </div>
                  </td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Net Income Summary -->
    <div v-if="data" 
      class="rounded-lg shadow-lg p-6 text-white"
      :class="data.net_income >= 0 ? 'bg-gradient-to-br from-green-600 to-green-700' : 'bg-gradient-to-br from-red-600 to-red-700'"
    >
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium opacity-90">Net Income</p>
          <p class="text-xs opacity-75 mt-1">Laba Bersih</p>
        </div>
        <div class="text-right">
          <p v-if="data.comparative" class="text-xs opacity-75 mb-1">
            Previous: {{ formatCurrency(data.previous_year_net_income || 0) }}
          </p>
          <p class="text-3xl font-bold whitespace-nowrap tabular-nums">
            {{ formatCurrency(data.net_income) }}
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue';

const props = defineProps({
  data: {
    type: Object,
    default: null
  }
});

const emit = defineEmits(['view-coa']);

const hasData = computed(() => props.data !== null);

const openCoaDetail = (item) => {
  if (!item) return;
  emit('view-coa', item);
};

const formatDate = (dateStr) => {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('id-ID', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const formatCurrency = (amount) => {
  if (amount === null || amount === undefined) return 'Rp 0';
  const numericValue = Number(amount);
  const formatted = new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(Math.abs(numericValue));
  return numericValue < 0 ? `(${formatted})` : formatted;
};

const copyToClipboard = async (amount) => {
  const numericValue = Number(amount ?? 0);
  const textToCopy = Number.isFinite(numericValue)
    ? numericValue.toString()
    : '0';

  try {
    if (navigator?.clipboard?.writeText) {
      await navigator.clipboard.writeText(textToCopy);
      return;
    }

    const textarea = document.createElement('textarea');
    textarea.value = textToCopy;
    textarea.setAttribute('readonly', '');
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
  } catch (error) {
    console.error('Failed to copy amount:', error);
  }
};
</script>
