<!DOCTYPE html>
<html>

<head>
  <title>Bank Statement PDF to Excel Converter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      min-height: 100vh;
      display: flex;
      align-items: center;
    }

    .container {
      max-width: 800px;
      padding: 2rem;
    }

    .upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      background: white;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #0d6efd;
      background: #f8f9fa;
    }

    .upload-icon {
      font-size: 48px;
      color: #6c757d;
      margin-bottom: 1rem;
    }

    #loading {
      display: none;
      margin-top: 1rem;
    }

    .success-message {
      display: none;
      color: #198754;
      margin-top: 1rem;
    }

    .file-info {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #6c757d;
    }

    .file-name {
      font-weight: 500;
      color: #212529;
    }

    .conversion-note {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.5rem;
    }

    .bank-selector {
      margin-bottom: 2rem;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal.show {
      display: block;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="mb-5 text-center">
      <h1 class="mb-3 display-4">Bank Statement Converter</h1>
      <p class="lead text-muted">Convert your Bank Statement PDF to Excel format in seconds</p>
    </div>

    <div class="shadow-sm card">
      <div class="p-4 card-body">
        <form id="pdfForm">
          <div class="text-center bank-selector">
            <h5 class="mb-3">Select Your Bank</h5>
            <select class="mx-auto form-select form-select-lg w-50" id="bankType" name="bank_type" required>
              <option value="">Choose bank...</option>
              <option value="bca">REK BCA</option>
              <option value="mandiri">REK Mandiri</option>
              <option value="ccbca">CC BCA</option>
              <option value="dbs">CC DBS</option>
              <option value="ccmandiri">CC Mandiri</option>
            </select>
          </div>
          <div class="mb-4 text-center">
            <h5 class="mb-3">Choose Output Format</h5>
            <div class="d-flex justify-content-center gap-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="output_format" id="formatExcel" value="excel" checked>
                <label class="form-check-label" for="formatExcel">Excel (.xlsx)</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="output_format" id="formatCsv" value="csv">
                <label class="form-check-label" for="formatCsv">CSV (.csv)</label>
              </div>
            </div>
          </div>
          <div class="mb-4 upload-area" id="dropZone" onclick="document.getElementById('pdfFile').click();">
            <i class="bi bi-cloud-arrow-up upload-icon"></i>
            <h5>Drag & Drop your Bank Statement PDF here</h5>
            <p class="text-muted">or click to browse</p>
            <input type="file" class="form-control d-none" id="pdfFile" name="pdf_file" accept=".pdf" required>
            <div id="fileName" class="mt-2 file-name"></div>
            <div class="conversion-note" id="formatNote">
              Please select a bank to see format requirements
            </div>
          </div>
          <div class="text-center">
            <button type="submit" class="px-4 btn btn-primary btn-lg">
              <i class="bi bi-file-earmark-arrow-down me-2"></i>Convert File
            </button>
            <div id="loading" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Converting your file...</p>
            </div>
            <div id="successMessage" class="success-message">
              <i class="bi bi-check-circle me-2"></i>Conversion successful!
            </div>
          </div>
        </form>
        <div id="errorMessage" class="mt-3 alert alert-danger" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h5 class="mb-3">PDF Password Required</h5>
      <p class="mb-3 text-muted">This PDF is password protected. Please enter the password to continue.</p>
      <div class="mb-3">
        <input type="password" class="form-control" id="pdfPassword" placeholder="Enter PDF password">
      </div>
      <div id="passwordError" class="mb-3 text-danger" style="display: none;"></div>
      <div class="gap-2 d-flex justify-content-end">
        <button type="button" class="btn btn-secondary" onclick="closePasswordModal(true)">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitPassword()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('pdfFile');
    const fileName = document.getElementById('fileName');
    const loading = document.getElementById('loading');
    const successMessage = document.getElementById('successMessage');
    const errorDiv = document.getElementById('errorMessage');
    const bankType = document.getElementById('bankType');
    const formatNote = document.getElementById('formatNote');
    const passwordError = document.getElementById('passwordError');

    const bankFormats = {
      'bca': 'Format: BCA Statement with columns for Date, Description (2 parts), CBG, Mutation, and Balance',
      'mandiri': 'Format: Mandiri Statement with columns for Date, Description, Debit, Credit, and Balance',
      'ccbca': 'Format: BCA Credit Card Statement with columns for Date, Description, Amount, and Balance',
      'dbs': 'Format: DBS Credit Card Statement with transaction details including Date, Description, Debit, Credit, and Balance',
      'ccmandiri': 'Format: Mandiri Credit Card Statement with columns for Date, Description, Amount, and Balance'
    };

    bankType.addEventListener('change', function () {
      const selectedBank = this.value;
      if (selectedBank in bankFormats) {
        formatNote.textContent = bankFormats[selectedBank];
      } else {
        formatNote.textContent = 'Please select a bank to see format requirements';
      }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropZone.classList.add('border-primary');
    }

    function unhighlight(e) {
      dropZone.classList.remove('border-primary');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      updateFileName();
    }

    fileInput.addEventListener('change', updateFileName);

    function updateFileName() {
      const file = fileInput.files[0];
      if (file) {
        fileName.textContent = file.name;
      } else {
        fileName.textContent = '';
      }
    }

    const passwordModal = document.getElementById('passwordModal');
    let currentFile = null;
    let isPasswordProtected = false;

    function showPasswordModal(message = '') {
      passwordModal.classList.add('show');
      document.getElementById('pdfPassword').value = '';
      document.getElementById('pdfPassword').focus();
      passwordError.textContent = message || '';
      passwordError.style.display = message ? 'block' : 'none';
    }

    function closePasswordModal(resetSelection = false) {
      passwordModal.classList.remove('show');
      passwordError.textContent = '';
      passwordError.style.display = 'none';
      if (resetSelection) {
        fileInput.value = '';
        fileName.textContent = '';
        currentFile = null;
      }
      isPasswordProtected = false;
    }

    async function checkPasswordProtection(file) {
      const formData = new FormData();
      formData.append('pdf_file', file);
      
      try {
        const response = await fetch('/check_password', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        return result.password_protected;
      } catch (error) {
        console.error('Error checking password protection:', error);
        return false;
      }
    }

    async function submitPassword() {
      const password = document.getElementById('pdfPassword').value;
      if (!password) return;

      const formData = new FormData();
      formData.append('pdf_file', currentFile);
      formData.append('password', password);
      formData.append('bank_type', bankType.value);
      formData.append('output_format', getSelectedOutputFormat());

      closePasswordModal();
      loading.style.display = 'block';
      errorDiv.style.display = 'none';

      try {
        const response = await requestConversion(formData);
        await handleSuccessfulConversion(response);
      } catch (error) {
        handleConversionError(error);
      }
    }

    function getSelectedOutputFormat() {
      const selected = document.querySelector('input[name="output_format"]:checked');
      return selected ? selected.value : 'excel';
    }

    function getFilenameFromResponse(response, fallbackName) {
      const contentDisposition = response.headers.get('Content-Disposition');
      if (contentDisposition) {
        const match = contentDisposition.match(/filename\*=UTF-8''([^;]+)|filename=\"?([^\";]+)\"?/i);
        if (match) {
          const filename = decodeURIComponent(match[1] || match[2]);
          if (filename) {
            return filename;
          }
        }
      }
      return fallbackName;
    }
    
    async function requestConversion(formData) {
      const response = await fetch('/convert_pdf', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        let message = 'Conversion failed. Please try again.';
        let requirePassword = false;
        
        try {
          const data = await response.json();
          if (data && data.error) {
            message = data.error;
          }
          if (data && data.require_password) {
            requirePassword = true;
          }
        } catch (jsonError) {
          try {
            const text = await response.text();
            if (text) {
              message = text;
            }
          } catch (textError) {
            console.error('Unable to read error response:', textError);
          }
        }
        
        const error = new Error(message);
        if (requirePassword) {
          error.requirePassword = true;
        }
        throw error;
      }
      
      return response;
    }

    async function handleSuccessfulConversion(response) {
      const outputFormat = getSelectedOutputFormat();
      const fallbackFilename = `${bankType.value || 'statement'}_statement.${outputFormat === 'csv' ? 'csv' : 'xlsx'}`;
      const downloadName = getFilenameFromResponse(response, fallbackFilename);
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = downloadName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      loading.style.display = 'none';
      successMessage.style.display = 'block';
      errorDiv.style.display = 'none';
      fileInput.value = '';
      fileName.textContent = '';
      currentFile = null;
      isPasswordProtected = false;
      document.getElementById('pdfPassword').value = '';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 3000);
    }

    function handleConversionError(error) {
      loading.style.display = 'none';
      const message = error && error.message ? error.message : 'An unexpected error occurred.';
      const needsPassword = Boolean(error && error.requirePassword);

      if (currentFile && (needsPassword || message.toLowerCase().includes('password'))) {
        isPasswordProtected = true;
        showPasswordModal(message);
        errorDiv.style.display = 'none';
        return;
      }

      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    document.getElementById('pdfForm').onsubmit = async (e) => {
      e.preventDefault();
      errorDiv.style.display = 'none';
      loading.style.display = 'block';
      successMessage.style.display = 'none';

      currentFile = fileInput.files[0];
      if (!currentFile) return;

      try {
        isPasswordProtected = await checkPasswordProtection(currentFile);
        if (isPasswordProtected) {
          showPasswordModal();
        } else {
          const formData = new FormData(e.target);
          formData.set('output_format', getSelectedOutputFormat());
          loading.style.display = 'block';
          errorDiv.style.display = 'none';
          
          const response = await requestConversion(formData);
          await handleSuccessfulConversion(response);
        }
      } catch (error) {
        handleConversionError(error);
      }
    };
  </script>
</body>

</html>
